<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
          integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
    <meta charset="UTF-8">
    <link href="/favicon.ico" rel="shortcut icon" type="image/x-icon">
    <title>Apple Passkey Demo with Hanko Authentication API</title>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="#">Apple Passkey Demo with Hanko Authentication API</a>
</nav>
<div class="container pt-5">
    <div class="row">
        <div class="col-sm">
            <form class="form" onsubmit="do_auth(event);">
                <h3 class="text-center text-danger">Welcome</h3>
                <div class="form-group text-center">
                    <button type="submit" class="btn btn-outline-danger btn-md mt-4">Sign in</button>
                </div>
                <p class="text-center">Don't have an account? <a href="/register">Register here!</a></p>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@teamhanko/hanko-webauthn@latest/dist/browser-global/hanko-webauthn.browser-global.js"></script>
<script type="application/javascript">
async function do_auth(event) {
    event.preventDefault()
    const authInitResponse = await fetch('/authentication_initialize', {
        method: 'GET'
    })

    if (!authInitResponse.ok) {
        // TODO: showError
        console.log((await authInitResponse.json()).error)
    }

    const authOptions = await authInitResponse.json()

    const authenticatorResponse = await hankoWebAuthn.get(authOptions)

    const authenticationResponse = await fetch('/authentication_finalize', {
        method: 'POST',
        body: JSON.stringify(authenticatorResponse)
    })

    if (!authenticationResponse.ok) {
        // TODO: show Error
        console.log((await authenticationResponse.json()).error)
    } else {
        location.assign('/content')
    }
}
</script>
</body>
</html>